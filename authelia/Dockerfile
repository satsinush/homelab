# Stage 1: Builder to generate configuration.yml
FROM alpine:3.20 AS builder

# Install necessary tools
RUN apk add --no-cache gettext

# Set working directory
WORKDIR /config

# Copy all necessary files for building the config
COPY authelia/configuration.yml.template .
COPY volumes/authelia/private.pem ./jwks/private.pem
COPY authelia/build_config.sh .

# Make the build script executable
RUN chmod +x build_config.sh

# Pass all build arguments to the environment so the script can use them
ARG AUTHELIA_SESSION_SECRET
ARG AUTHELIA_STORAGE_ENCRYPTION_KEY
ARG AUTHELIA_JWT_SECRET
ARG LLDAP_LDAP_BASE_DN
ARG LLDAP_LDAP_USER_PASS
ARG AUTHELIA_WEB_HOSTNAME
ARG HOMELAB_HOSTNAME
ARG VAULTWARDEN_OIDC_HASHED_SECRET
ARG VAULTWARDEN_WEB_HOSTNAME
ARG AUTHELIA_HMAC_SECRET
ARG PORTAINER_WEB_HOSTNAME
ARG PORTAINER_OIDC_HASHED_SECRET
ARG DASHBOARD_OIDC_HASHED_SECRET
ARG DASHBOARD_WEB_HOSTNAME
ARG LLDAP_LDAP_USER_DN
ARG HOMELAB_USERNAME
ARG HOMELAB_PASSWORD

ENV AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET}
ENV AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_ENCRYPTION_KEY}
ENV AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET}
ENV LLDAP_LDAP_BASE_DN=${LLDAP_LDAP_BASE_DN}
ENV LLDAP_LDAP_USER_PASS=${LLDAP_LDAP_USER_PASS}
ENV AUTHELIA_WEB_HOSTNAME=${AUTHELIA_WEB_HOSTNAME}
ENV HOMELAB_HOSTNAME=${HOMELAB_HOSTNAME}
ENV VAULTWARDEN_OIDC_HASHED_SECRET=${VAULTWARDEN_OIDC_HASHED_SECRET}
ENV VAULTWARDEN_WEB_HOSTNAME=${VAULTWARDEN_WEB_HOSTNAME}
ENV AUTHELIA_HMAC_SECRET=${AUTHELIA_HMAC_SECRET}
ENV PORTAINER_WEB_HOSTNAME=${PORTAINER_WEB_HOSTNAME}
ENV PORTAINER_OIDC_HASHED_SECRET=${PORTAINER_OIDC_HASHED_SECRET}
ENV DASHBOARD_OIDC_HASHED_SECRET=${DASHBOARD_OIDC_HASHED_SECRET}
ENV DASHBOARD_WEB_HOSTNAME=${DASHBOARD_WEB_HOSTNAME}
ENV LLDAP_LDAP_USER_DN=${LLDAP_LDAP_USER_DN}
ENV HOMELAB_USERNAME=${HOMELAB_USERNAME}
ENV HOMELAB_PASSWORD=${HOMELAB_PASSWORD}

# Run the build script to generate the final configuration.yml
RUN ./build_config.sh

# Stage 2: Official Authelia image
FROM authelia/authelia:latest

# Copy only the final, generated config from the builder stage
COPY --from=builder /config/configuration.yml /config/configuration.yml